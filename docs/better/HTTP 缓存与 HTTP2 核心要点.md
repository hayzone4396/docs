---
title: HTTP 缓存与 HTTP/2 核心要点
date: 2026-01-14
tags: 
 - 缓存
 - HTTP/2
categories:
 - 追求更好
---
# HTTP 缓存与 HTTP/2 核心要点

## HTTP 缓存核心

### 两种缓存机制

**强缓存（Strong Cache）**
- 完全不发请求到服务器
- 响应头：`Cache-Control: max-age=31536000, public`
- 浏览器直接使用缓存，速度极快（1-5ms）

**协商缓存（Negotiated Cache）**
- 发送请求到服务器验证
- 响应头：`Cache-Control: no-cache` + `ETag` 或 `Last-Modified`
- 未修改返回 304（只传输头部），已修改返回 200 + 新资源

### 关键指令说明

| 指令 | 含义 | 是否缓存 | 是否验证 | 适用场景 |
|------|------|---------|---------|---------|
| **no-cache** | 必须验证 | ✅ 缓存 | ✅ 每次验证 | API、HTML |
| **no-store** | 完全不缓存 | ❌ 不缓存 | N/A | 敏感数据 |
| **max-age** | 缓存时间（秒） | ✅ 缓存 | ❌ 过期前不验证 | 静态资源 |
| **public** | 允许 CDN 缓存 | ✅ | - | 公开资源 |
| **private** | 仅浏览器缓存 | ✅ | - | 个人数据 |

**重要：no-cache 不是"不使用缓存"**
- no-cache 会缓存，但每次使用前必须验证
- no-store 才是真正的不缓存

### 不同资源的缓存策略

| 资源类型 | Cache-Control | 原因 |
|---------|--------------|------|
| HTML | `no-cache` | 需要最新内容 |
| CSS/JS（带版本号） | `max-age=31536000, immutable` | 永不改变 |
| CSS/JS（无版本号） | `max-age=86400` 或 `no-cache` | 可能更新 |
| 图片（产品图） | `max-age=2592000` | 很少改变 |
| API（用户数据） | `private, no-cache` | 个人数据，需验证 |
| API（统计数据） | `public, max-age=60` | 可短期缓存 |
| API（敏感数据） | `private, no-store` | 不能缓存 |

---

## HTTP/2 核心特性

### 解决的问题

| 问题 | HTTP/1.1 | HTTP/2 解决方案 |
|------|----------|---------------|
| 队头阻塞 | 一个请求阻塞后续请求 | 多路复用，请求并发执行 |
| 连接数限制 | 浏览器限制 6-8 个连接 | 单一连接处理所有请求 |
| 头部冗余 | 每次请求都发送完整头部 | 头部压缩（HPACK），压缩率 80-90% |
| 无优先级 | 所有资源平等对待 | 请求优先级和依赖关系 |
| 服务器被动 | 只能响应请求 | 服务器推送（Server Push） |

### 核心特性

**1. 多路复用（Multiplexing）**
- 单一 TCP 连接上同时处理多个请求/响应
- 请求并发执行，互不阻塞
- 性能提升：40-50%（资源密集型页面）

**2. 头部压缩（HPACK）**
- 首次请求建立头部索引表
- 后续请求只发送索引，大幅减少头部大小
- 压缩效果：1200 字节 → 200 字节

**3. 服务器推送（Server Push）**
- 服务器主动推送关键资源
- 减少往返次数（RTT）
- 节省时间：100-200ms

**4. 二进制协议**
- HTTP/1.1 是文本协议（解析慢）
- HTTP/2 是二进制协议（解析快）

### 适用场景

**适合使用**
- 资源密集型网页（大量小文件）
- API 密集型应用（频繁请求）
- 移动端应用（延迟敏感）

**不适合或效果不明显**
- 资源极少的简单页面
- 大文件下载（单个请求）
- 已高度优化的 HTTP/1.1 站点（需反向优化）

### 部署要求

- **必须使用 HTTPS**（浏览器要求）
- Web 服务器配置：`listen 443 ssl http2;`
- 获取 SSL 证书（Let's Encrypt 免费）

---

## 缓存与 HTTP/2 的关系

### 关键结论

**HTTP/2 不是缓存优化，而是传输层优化**

```
性能优化层级：

第1层: 缓存（最有效）
       ↓ 避免网络请求
       └─ 浏览器缓存、CDN 缓存

第2层: 传输优化
       ↓ 减少传输时间
       └─ HTTP/2（多路复用、头部压缩）

第3层: 渲染优化
       ↓ 加快页面显示
       └─ 代码分割、懒加载
```

### 互补关系

**HTTP/2 不能替代缓存**
- 首次访问：HTTP/2 加速加载（多路复用）
- 重复访问：缓存直接读取（无需网络请求）

**最佳策略**
- 静态资源：HTTP/2 + 强缓存（1年）
- HTML：HTTP/2 + 协商缓存（ETag）
- API：HTTP/2 + 短期缓存或 no-cache

---

## 实战配置要点

### Nginx 配置示例

```nginx
server {
    # HTTP/2 配置
    listen 443 ssl http2;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # HTML：协商缓存
    location ~* \.html$ {
        add_header Cache-Control "no-cache";
        etag on;
    }
    
    # CSS/JS（带版本号）：强缓存
    location ~* \.(css|js)$ {
        if ($args ~* "v=") {
            add_header Cache-Control "public, max-age=31536000, immutable";
        }
    }
    
    # 图片：长期缓存
    location ~* \.(jpg|jpeg|png|gif|svg|webp)$ {
        add_header Cache-Control "public, max-age=2592000";
    }
    
    # API：让应用层控制缓存
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_pass_header Cache-Control;
    }
}
```

### 关键要点

1. **启用 HTTP/2**：必须 HTTPS + `http2` 指令
2. **缓存策略**：根据资源类型选择强缓存或协商缓存
3. **版本号管理**：CSS/JS 使用版本号或哈希，实现长期缓存
4. **API 缓存**：用户数据用 `no-cache`，统计数据可短期缓存

---

## 关键概念速查

### HTTP 缓存术语

| 术语 | 含义 | 网络请求 | 数据传输 |
|------|------|---------|---------|
| **强缓存** | 直接使用缓存 | ❌ 无 | ❌ 无 |
| **协商缓存** | 验证后使用 | ✅ 有 | ⚠️ 可能无（304） |
| **no-cache** | 必须验证 | ✅ 有 | ⚠️ 看情况 |
| **no-store** | 完全不缓存 | ✅ 有 | ✅ 有 |

### HTTP/2 vs HTTP/1.1

| 特性 | HTTP/1.1 | HTTP/2 |
|------|----------|--------|
| 连接数 | 6-8 个并发连接 | 单一连接 |
| 队头阻塞 | 存在 | 不存在 |
| 头部大小 | 500-1500 字节/请求 | 首次 1200 字节，后续 200 字节 |
| 协议格式 | 文本 | 二进制 |
| 服务器推送 | 不支持 | 支持 |

### 性能对比

**缓存命中**：
- 强缓存：1-5ms（最快）
- 协商缓存（304）：50-100ms（只传输头部）

**首次加载（无缓存）**：
- HTTP/1.1：受限于 6 个并发连接，需要多批次
- HTTP/2：所有请求并发，性能提升 30-50%

### 最佳实践总结

1. **HTML**：`no-cache`（确保内容最新）
2. **CSS/JS（带版本号）**：`max-age=31536000, immutable`（永久缓存）
3. **API（用户数据）**：`private, no-cache`（个人数据，需验证）
4. **API（统计数据）**：`public, max-age=60`（短期缓存）
5. **启用 HTTP/2**：必须 HTTPS，显著提升资源密集型页面性能
6. **组合使用**：HTTP/2 优化首次加载，缓存优化重复访问

---

## 常见误区

1. **no-cache 不是"不使用缓存"**
   - 正确：no-cache 会缓存，但每次必须验证
   - no-store 才是真正的不缓存

2. **HTTP/2 不能替代缓存**
   - HTTP/2 优化传输层（首次加载）
   - 缓存优化应用层（重复访问）
   - 两者互补，不是替代关系

3. **HTTP/2 需要反向优化**
   - 移除域名分片（合并到单一域名）
   - 拆分大 bundle（利用浏览器缓存）
   - 移除 CSS 精灵图（按需使用独立图片）
